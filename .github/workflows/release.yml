name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.6). Leave empty to use pyproject.toml version."
        required: false
        type: string
      skip_pypi:
        description: "Skip PyPI publishing"
        required: false
        type: boolean
        default: false
      skip_docker:
        description: "Skip Docker publishing"
        required: false
        type: boolean
        default: false

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Run ruff check
        run: uv run ruff check src/ tests/

      - name: Run tests
        run: uv run pytest tests/ -v

  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.version.outputs.version }}
      docker_tags: ${{ steps.docker.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # Extract version from tag (v1.2.3 -> 1.2.3)
            VERSION="${GITHUB_REF_NAME#v}"
          elif [[ -n "${{ inputs.version }}" ]]; then
            # Use workflow_dispatch input
            VERSION="${{ inputs.version }}"
          else
            # Read from pyproject.toml
            VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Determined version: $VERSION"

      - name: Prepare Docker tags
        id: docker
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAGS="likanwen/router-maestro:${VERSION},likanwen/router-maestro:latest"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Docker tags: $TAGS"

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ !inputs.skip_pypi }}
    environment:
      name: pypi
      url: https://pypi.org/project/router-maestro/
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Build package
        run: uv build

      - name: Verify build version
        run: |
          EXPECTED_VERSION="${{ needs.prepare.outputs.version }}"
          BUILT_VERSION=$(ls dist/*.tar.gz | grep -Po 'router_maestro-\K[0-9]+\.[0-9]+\.[0-9]+')
          if [[ "$BUILT_VERSION" != "$EXPECTED_VERSION" ]]; then
            echo "Version mismatch! Expected: $EXPECTED_VERSION, Built: $BUILT_VERSION"
            exit 1
          fi
          echo "Version verified: $BUILT_VERSION"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true

  publish-docker:
    name: Publish Docker Image
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ !inputs.skip_docker }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ needs.prepare.outputs.docker_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, publish-pypi, publish-docker]
    if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
